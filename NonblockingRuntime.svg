<?xml version="1.0" encoding="UTF-8"?>
<!-- Do not edit this file with editors other than diagrams.net -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1281px" height="1261px" viewBox="-0.5 -0.5 1281 1261" content="&lt;mxfile host=&quot;drawio-plugin&quot; modified=&quot;2023-06-06T19:23:51.611Z&quot; agent=&quot;5.0 (Windows NT 6.2; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.102 Safari/537.36&quot; etag=&quot;yi_7R9etYmre4eie20te&quot; version=&quot;20.5.3&quot; type=&quot;embed&quot;&gt;&lt;diagram id=&quot;23iRSUPoRavnBvh4doch&quot; name=&quot;Page-1&quot;&gt;7VpZc+I4EP41VCUPUMbmCI8JmZ3dqr1qZ7b2MSVkgVWRJY8sB9hfv63D8YEI3gRyv4Dd1tH99am2e9E83XyVKEt+EzFhvTCIN73ouheGw0k4gj9N2VpKGAWOspI0dqMqwjf6L3HEwFELGpO8MVAJwRTNmkQsOCdYNWhISrFuDlsK1tw1QyuyQ/iGEdul/kNjlTjqcDKrHvxM6Copt56MnYApKkc7UfIExWJdI0VfetFcCqHsVbqZE6bhK4Gx837a8/SeM0m46jIhtBPuECuccI4vtS2llaLgMdHjg150tU6oIt8yhPXTNSgYaIlKGdwN4XJ3f8fSHZGKbGokx89XIlKi5BaGuKejEhtnHjN3u66gjsohSQ3laOyIyKl3db90BQBcOAz8eEQePCZMaSGB68lKGRktJc8Qb0A1+VFovV0tEL5dGdj6WDAhe9Gl3oJTRRGzC7iR5ZKAKqwRBmdKFuS83GAh21sC+3bXjpwsBVf93DiQZmEYZhszLTAP1g49/WgUBF7O4B+lWsl8kWd27i7pCcx15IGVE7qICQa48S60QAonWgI9OSB3YKT5IBOMnZ3XhLDbdAIeyLt2sUuJ6d3p1HMcaDx6XoLlgkmCv6fGfOHHAHiuEZxeHUbMiP0ekPCQ8jW1tmTwGahtRj5x8ZNUIgmKbzJI0YO8WKRUGczOvWvuDS0fEcvp9bsF4JGitQJuq1SBCsME4KoeyZUUt2Rus/A1F5xoJiljLRIEd0z5Cgjj6u67AEVc98N9dY+AombJTPmW0DgmHGjNaukY5dCoWQ4NJ556aOiph8LpEeqhUYd6aA7ak0LPuiWSm2LfunyubXge9WZTU4xLYv4Ko+v96TNrE7xlUPZ2jEBbtzvEhMcyiuG4YRT9yGMU0/GuUQzDIxjF+PUdGqazFzw0TDo4yVrIWwMRQUzbWOkjWnChneejxrfprGnK4eg549u0S3z7829Y5pc/6nHtTWrrBIGo7Xf9YUftHSUQXby+QAQAHIxEYx8gR4lEsw7mfJll/gyN9F2K+La85oRo6D6N/V63razrC1Uny7ql0Tx3bypXSKobnb+IvLFmozPW2bm3RLOjsS0J3fB8z9h216t1en5Cw+WdNcSCrscq17Jhegm70M19mWEaOE4hTwDbcyg7oUCPazrsyj/IJCFpphqWuF/sfYfq55T7/7WAXwnTB5XVOPe/FUE4JLfKkcxmELSsK90wwlfKdJVDvcfQ+JY+I5XONijPvIfAKXPyuLHh+HpQ5BB6lwXHigr+GBN+7cn6GMn5otUnCT2FV3Cqc8Rw2CE5X1qBNNM5RgwtTPZLC6ao1bUutgIkscYQq0I3TPZmlgcaJ98TUj9fKpGBElfbeg4gFm6VD+BiLtIF5USXfC5MUsvaCu5qWcOAaUy9dXYNgN2El5sgrp8wuoDfQtrDrk1MCaCuJ4E5CAmVJrYdIY4LCZrH1WRgDTFGGM3TwWfTZ1/5GXpagbMLT/0ZBscwcd+74meoP38XvL9gAt9aS/oL/hbFcklkfjgIPqlWPMzq3oSyW05ybfB+AX+tqpW6a5XxPjcxQXtKxZDml0gwHe1oYkWx2UEZDecCU6RMKHHeirQr0zvjypL8KEgOI+dmL6LtCycE6+aUrEML61W4s62JI8Zb07TgFMMOZrU8Aw5N6FhKod8T6j7Jg2rxljQf/mTZ6hqMxp6j5cyTvcajY7j2C332UL05MIiXaQLV7bTT0SommNrsmRCTNd9bAPh00Zd20fZnSSNf82d0Mg/t9iIuzQqFtM1oHlCWEWM8b9EnLo34+AGJBp9G/OR2vdeIj5Vm4Lb6kNE8q30QGn35Dw==&lt;/diagram&gt;&lt;/mxfile&gt;"><defs/><g><rect x="520" y="360" width="320" height="350" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><rect x="540" y="430" width="310" height="270" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 302px; height: 1px; padding-top: 420px; margin-left: 545px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 280px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1><span style="background-color: initial;">while (true)<br /></span><span style="font-size: 12px; font-weight: 400;">   </span><span style="font-weight: 400;"><font style="font-size: 20px;">batch = events.poll()</font></span></h1><h1><div style="font-size: 12px; font-weight: 400;"><font style="font-size: 20px;">  for (item in batch) {</font></div><div style="font-size: 12px; font-weight: 400;"><font style="font-size: 20px;">    switch (item.type) {</font></div><div style="font-size: 12px; font-weight: 400;"><font style="font-size: 20px;">      thread_pool.submit(item);  </font></div><div style="font-size: 12px; font-weight: 400;"><font style="font-size: 20px;">    }</font></div><div style="font-size: 12px; font-weight: 400;"><font style="font-size: 20px;">}</font></div></h1></div></div></div></foreignObject><text x="545" y="432" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px">while (true)...</text></switch></g><rect x="515" y="240" width="375" height="120" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 367px; height: 1px; padding-top: 230px; margin-left: 520px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 130px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1>Control kernel threads × core count</h1><p><br /></p></div></div></div></foreignObject><text x="520" y="250" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">Control kernel threads × core count&#xa;</text></switch></g><rect x="890" y="360" width="320" height="350" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><rect x="895" y="510" width="310" height="270" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 302px; height: 1px; padding-top: 500px; margin-left: 900px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 280px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1>work stealing thread pool</h1></div></div></div></foreignObject><text x="900" y="512" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px">work stealing thread pool</text></switch></g><rect x="890" y="260" width="310" height="120" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 302px; height: 1px; padding-top: 250px; margin-left: 895px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 130px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1>CPU/IO threads</h1></div></div></div></foreignObject><text x="895" y="270" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">CPU/IO threads</text></switch></g><rect x="0" y="360" width="510" height="350" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" pointer-events="all"/><rect x="85" y="230" width="375" height="120" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 367px; height: 1px; padding-top: 220px; margin-left: 90px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 130px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1>App threads × as many as needed</h1></div></div></div></foreignObject><text x="90" y="240" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">App threads × as many as needed</text></switch></g><rect x="20" y="390" width="500" height="270" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 492px; height: 1px; padding-top: 380px; margin-left: 25px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 280px; overflow: hidden;"><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1><span style="background-color: initial;">start_worker_threadpool();<br />start_control_threads();<br />while (true) {</span></h1><h1><span style="font-size: 12px; font-weight: 400;">   </span><span style="font-weight: 400; font-size: 20px;">for (lightweight_thread in threads) {</span></h1><div><span style="font-weight: 400; font-size: 20px;">     lightweight_thread.preempt();</span></div><div><span style="font-weight: 400; font-size: 20px;"><br /></span></div><div><span style="font-weight: 400; font-size: 20px;">   }</span></div><div><span style="font-weight: 400; font-size: 20px;"> next_thread = (threads_length + 1) % threads.count   threads[next_thread].user_function();</span></div></div></div></div></foreignObject><text x="25" y="392" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px">start_worker_threadpool();...</text></switch></g><rect x="85" y="10" width="985" height="200" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 977px; height: 1px; padding-top: 0px; margin-left: 90px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 210px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1>A very scalable multithreaded architecture </h1><p>The thread topology in three parts. Combines preemptible green threads with thread pool technology and lib uring for high performance concurrency and parallelism.</p></div></div></div></foreignObject><text x="90" y="20" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">A very scalable multithreaded architecture...</text></switch></g><rect x="0" y="720" width="390" height="540" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 382px; height: 1px; padding-top: 710px; margin-left: 5px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 550px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1><span style="background-color: initial;">Non-blocking Ringbuffers</span></h1><h1><span style="background-color: initial; font-size: 20px; font-weight: normal;">Lightweight thread functions are background server logic not associated with a given request, they check ringbuffers non-blockingly to communicate responses from IO</span><br /></h1></div></div></div></foreignObject><text x="5" y="730" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">Non-blocking Ringbuffers...</text></switch></g><rect x="520" y="710" width="340" height="540" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 332px; height: 1px; padding-top: 700px; margin-left: 525px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 550px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1><span style="background-color: initial;">Control flow for a request </span>decided here</h1><h1><span style="background-color: initial; font-size: 20px; font-weight: normal;">Lightweight thread functions check ringbuffers non-blockingly to communicate responses from IO</span><br /></h1></div></div></div></foreignObject><text x="525" y="720" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">Control flow for a request decide...</text></switch></g><rect x="890" y="710" width="390" height="540" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe flex-start; justify-content: unsafe flex-start; width: 382px; height: 1px; padding-top: 700px; margin-left: 895px;"><div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: left; max-height: 550px; overflow: hidden;"><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;"><h1>Computation happens here</h1><h1><span style="background-color: initial; font-size: 20px; font-weight: normal;">All computation happens here.</span><br /></h1></div></div></div></foreignObject><text x="895" y="720" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="20px">Computation happens here...</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Text is not SVG - cannot display</text></a></switch></svg>